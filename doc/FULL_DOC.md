# gizmo_carver

Python scripts for generating synthetic observations from a GIZMO dataset
using yt and RADMC-3D

## Summary

Together, the four Python scripts `globals_gizmo_carver.py`, `inputs_gizmo_carver.py`, 
`main_gizmo_carver.py`, and `writer_gizmo_carver.py` constitute a pipeline for
generating a complete set of input files for use with [RADMC-3D](https://www.ita.uni-heidelberg.de/~dullemond/software/radmc-3d/description.php).
The pipeline is designed for GIZMO datasets, and is used to "carve out"
a section of a given dataset to produce synthetic observations of that section.

The repo also contains the `radmc_image_processing.py` script, which can be 
used to plot the moment 0, 1, and 2 maps of a RADMC-3D output image file.
For handeling the image.out file there is a replacement image.py file for the 
radmc3dPy tools set, which fixes a velocity bug that produced negative moment maps 
and allows for plotting in units of brightness temperature.

## Pipeline Overview

The graphic below shows the high-level prodecure for running the pipeline (steps 
involving the repo files are shown in blue):

<p align="center"><img src="https://github.com/seafen7/gizmo_carver/blob/main/doc/_static/pipeline_workflow.jpg?raw=true" alt="Pipeline workflow diagram"></p>

## File Contents

### globals_gizmo_carver.py

Contains constants and simple functions for use in the RadMC carving routines. Includes
the `Convert()` function, which is used to convert between units used in the carving 
routine. Should not need to edit this file.

### inputs_gizmo_carver.py

Input file containing constants and parameters for RadMC carving routines. These parameters 
include the coordinates and size of the carved-out box, parameters of the target molecular species,
filepath to the `default_files` directory and the output directory, the units of the box values, etc. 
This is the only file that requires editing during general use. 

### main_gizmo_carver.py

Driver file for RADMC carve routines. Generates necessary input files 
for RADMC-3D. These files will be generated in a working directory inside the 
specified output directory. Call this file to run the routine. 
Should not need to edit this file.

### writer_gizmo_carver.py

Writer class that compresses the relevant layers needed to create RADMC-3D 
amr, number density, line, and dust files. Contains custom covering_grid
function for the Gizmo file format. Should not need to edit this file.

### radmc_image_processing.py

Contains functions for plotting RADMC-3D output image files using RadMC3DPy 
and MatPlotLib. Edit this file to create custom plotting routines.

### default_files

Contains input files for RADMC-3D that are not generated by the carver routine.
These files are still necessary for running RADMC-3D and are used by the carver routine, 
but do not depend on the contents of the dataset file. **Currently, the default files 
included with the repository are set up specifically for the NH3 [1, 1] transition. 
Several files (such as `camera_wavelength_micron.inp` and `molecule_nh3.inp` as well as 
`inputs_gizmo_carver.py`) would need to be updated for observations of different molecules.**

## Detailed Procedure

1. Clone the repository to your local machine.
1. Create/specify a directory to store the output files.
1. Locate the desired GIZMO dataset file.
1. Update the `inputs_gizmo_carver.py` file.
    1. Update the `box_units`, `box_center`, `box_size`, and `box_dim` parameters
    to match the desired carving units, location, size, and resolution, respectively.
	1. Update the `molecular_abundance` parameter to reflect the number fraction of
	the target species. (The current target species is NH3)
    1. Update the `hdf5_file` parameter to give the correct filepath to the GIZMO
    dataset. (If the dataset is located in the same directory as the script files, 
    just the name of the dataset will be sufficient.)
    1. Update the `existing_filepath` parameter to give the correct filepath to the
    default files. These are files that are not generated by the carving routine, but
    are still necessary for running RADMC-3D. Some sample default files are provided
    in the `default_files` directory in the repo. **(Default files are for NH3)**
    The default files are as follows:
	
        ```
        camera_wavelength_micron.inp
        dustkappa_silicate.inp
        dustopac.inp
        lines.inp
        molecule_nh3.inp
        radmc3d.inp
        wavelength_micron.inp
        ```
    1. Update the `output_filepath` parameter with the filepath of the output directory
    mentioned earlier.
    
1. After the `inputs_gizmo_carver.py` file has been fully updated, run the 
`main_gizmo_carver.py` script to generate the input files. These files will be generated
in a new working directory located inside the specified output file directory.
1. Run RADMC-3D on the generated input files. Simply navigate to the generated output 
directory and run the RADMC-3D command (all the necessary .inp files should be located
in the output directory). A sample RADMC-3D command looks like:

    ```
    radmc3d image npix 64 loadlambda fluxcons inclline linelist nostar writepop sizepc 0.2 phi 0 incl 0 | tee output.txt
    ``` 
    **Important**: Ensure that the `npix` and `sizepc` parameters match up with those found in the 
    `inputs_gizmo_carver.py` file! Specifically, `npix` should match the `box_dim` parameter, and
    `sizepc` should match the `box_size` parameter (`sizepc` must be given in units of parsecs, so 
    convert `box_size` if necessary).

1. After RADMC-3D has generated the output file `image.out`, use `radmc_image_processing.py` to 
plot moment maps. See the comments in `radmc_image_processing.py` for more information.
        
## Dependencies

This carving routine was written and tested with the following package versions (See requirements.txt):

| Package       | Version       |
| ------------- |:-------------:|
| Python        | 3.9           |
| yt            | 4.0.2         |
| numpy         | 1.20.3        |
| radmc3dPy     | 0.30.2        |
| matplotlib    | 3.5.0         |
